<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeamFlow App</title>
    <meta name="description" content="BeamFlow private workspace">
    
    <!-- Theme color -->
    <meta name="theme-color" content="#dc2626">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000;
            color: #e5e7eb;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-container {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        
        .logo-icon {
            width: 2rem;
            height: 2rem;
            background-color: #dc2626;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.125rem;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc2626;
        }
        
        .logo-subtitle {
            color: #9ca3af;
            font-size: 0.875rem;
        }
        
        .spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid #374151;
            border-radius: 50%;
            border-top-color: #dc2626;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #9ca3af;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .loading-subtext {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .error {
            background-color: #7f1d1d;
            border: 1px solid #dc2626;
            color: #fecaca;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        .error h3 {
            color: #fca5a5;
            margin-bottom: 0.5rem;
        }
        
        .error a {
            color: #dc2626;
            text-decoration: none;
        }
        
        .error a:hover {
            text-decoration: underline;
        }
        
        #app-root {
            display: none;
            width: 100%;
            height: 100vh;
        }
        
        #app-root.loaded {
            display: block;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-container">
        <div class="logo">
            <div class="logo-icon">B</div>
            <div>
                <div class="logo-text">BeamFlow</div>
                <div class="logo-subtitle">for Unreal Engine</div>
            </div>
        </div>
        <div class="spinner"></div>
        <div class="loading-text">Loading your workspace...</div>
        <div class="loading-subtext">Connecting to desktop agent</div>
    </div>
    
    <div id="error-screen" class="loading-container" style="display: none;">
        <div class="logo">
            <div class="logo-icon">B</div>
            <div>
                <div class="logo-text">BeamFlow</div>
                <div class="logo-subtitle">for Unreal Engine</div>
            </div>
        </div>
        <div class="error">
            <h3>Authentication Required</h3>
            <p>You need to sign in to access this workspace.</p>
            <a href="/login/">Sign in now</a>
        </div>
    </div>
    
    <div id="app-root"></div>

    <!-- Load Supabase -->
    <script src="https://esm.sh/@supabase/supabase-js@2"></script>
    
    <!-- Load environment configuration -->
    <script src="/env.js"></script>
    
    <script>
        // Configuration
        const SUPABASE_URL = window.SUPABASE_URL || '___SUPABASE_URL___';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '___SUPABASE_ANON_KEY___';
        
        // DOM elements
        const loadingScreen = document.getElementById('loading-screen');
        const errorScreen = document.getElementById('error-screen');
        const appRoot = document.getElementById('app-root');
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Show error screen
        function showError() {
            loadingScreen.style.display = 'none';
            errorScreen.style.display = 'block';
        }
        
        // Show app
        function showApp() {
            loadingScreen.style.display = 'none';
            errorScreen.style.display = 'none';
            appRoot.classList.add('loaded');
        }
        
        // Check authentication and load app
        async function initializeApp() {
            try {
                // Check if user is authenticated
                const { data } = await supabase.auth.getSession();
                
                if (!data.session) {
                    // Not authenticated, redirect to login
                    window.location.href = '/login/';
                    return;
                }
                
                // User is authenticated, load the app
                showApp();
                
                // Load the app script
                const script = document.createElement('script');
                script.src = '/app/app.js';
                script.type = 'module';
                document.body.appendChild(script);
                
            } catch (error) {
                console.error('Authentication check failed:', error);
                showError();
            }
        }
        
        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                // User signed out, redirect to login
                window.location.href = '/login/';
            }
        });
        
        // Initialize the app
        initializeApp();
    </script>
</body>
</html>
